#:kivy 2.3.0
#:import dp kivy.metrics.dp
#:import sp kivy.metrics.sp

# ---------------------- COMPONENTES DA TABELA DE RESUMO ----------------------
# (têm bg_color com valor padrão e fallback seguro no canvas)

<TableGroupHeader@MDBoxLayout>:
    size_hint_y: None
    height: dp(40)
    padding: dp(12), 0
    spacing: dp(8)
    bg_color: 0.12, 0.35, 0.75, 1
    canvas.before:
        Color:
            rgba: (root.bg_color if hasattr(root, 'bg_color') and root.bg_color else (0.12, 0.35, 0.75, 1))
        Rectangle:
            pos: self.pos
            size: self.size
    MDLabel:
        id: left
        text: ""
        halign: "left"
        theme_text_color: "Custom"
        text_color: 1, 1, 1, 1
        font_style: "Button"
        shorten: True
        shorten_from: "right"
    MDLabel:
        id: right
        text: "Quantidade"
        halign: "right"
        theme_text_color: "Custom"
        text_color: 1, 1, 1, 1
        font_style: "Button"

<TableRow@MDBoxLayout>:
    size_hint_y: None
    height: dp(36)
    padding: dp(12), 0
    spacing: dp(8)
    bg_color: 1, 1, 1, 1
    canvas.before:
        Color:
            rgba: (root.bg_color if hasattr(root, 'bg_color') and root.bg_color else (1, 1, 1, 1))
        Rectangle:
            pos: self.pos
            size: self.size
    MDLabel:
        id: left
        text: ""
        halign: "left"
        shorten: True
        shorten_from: "right"
    MDLabel:
        id: right
        text: ""
        halign: "right"

<TableTotal@MDBoxLayout>:
    size_hint_y: None
    height: dp(38)
    padding: dp(12), 0
    spacing: dp(8)
    bg_color: 0.94, 0.96, 0.99, 1
    canvas.before:
        Color:
            rgba: (root.bg_color if hasattr(root, 'bg_color') and root.bg_color else (0.94, 0.96, 0.99, 1))
        Rectangle:
            pos: self.pos
            size: self.size
    MDLabel:
        id: left
        text: ""
        font_style: "Button"
        halign: "left"
    MDLabel:
        id: right
        text: ""
        font_style: "Button"
        halign: "right"

# ---------------------- TELA RESUMO ----------------------

<ResumoProducaoScreen@MDScreen>:
    name: "resumo"
    MDFloatLayout:
        MDTopAppBar:
            title: "Produção — " + app.data_hoje_str
            left_action_items: [["arrow-left", lambda x: app.nav_back()]]
            right_action_items: [["refresh", lambda x: app.atualizar_resumo()]]
            pos_hint: {"top": 1}
            elevation: 10

        MDRaisedButton:
            text: "Enviar Excel por e-mail"
            size_hint: .9, None
            height: dp(54)
            pos_hint: {"center_x": .5}
            # >>> ALTERADO: agora abre a confirmação
            on_release: app.abrir_confirmacao_exportar()

        ScrollView:
            id: resumo_scroll
            do_scroll_x: False
            do_scroll_y: True
            scroll_type: ["bars", "content"]   # permite arrastar conteúdo ou a barra
            bar_width: dp(6)
            bar_color: 0.12, 0.35, 0.75, 1
            bar_inactive_color: 0.12, 0.35, 0.75, .25
            # ajuste estes dois para encaixar na sua tela, se precisar:
            size_hint: 1, .70
            pos_hint: {"x": 0, "y": .08}

            MDBoxLayout:
                id: table_container
                orientation: "vertical"
                spacing: dp(4)
                padding: dp(12), dp(6)
                size_hint_y: None
                height: self.minimum_height  # <- essencial p/ o ScrollView rolar



# ---------------------- TILES (iguais ao design anterior) ----------------------

<TipoTile>:
    size_hint: 1, None
    height: dp(app.tipo_card_height_dp)
    radius: [16,]
    md_bg_color: 0.12, 0.35, 0.75, 1
    elevation: 3
    padding: dp(12)

    AnchorLayout:
        anchor_x: "center"
        anchor_y: "center"
        MDLabel:
            text: root.title
            halign: "center"
            valign: "middle"
            theme_text_color: "Custom"
            text_color: 1, 1, 1, 1
            font_size: sp(app.tipo_font_sp)
            size_hint_y: None
            text_size: self.width - dp(12), None
            height: self.texture_size[1] if self.texture_size[1] <= dp(app.tipo_card_height_dp) - dp(24) else dp(app.tipo_card_height_dp) - dp(24)
            max_lines: 3

    MDFlatButton:
        id: hit
        text: ""
        size_hint: 1, 1
        pos_hint: {"center_x": .5, "center_y": .5}
        md_bg_color: 0, 0, 0, 0

<ProdutoTile>:
    size_hint: 1, None
    height: dp(app.tipo_card_height_dp)
    radius: [16,]
    md_bg_color: 0.12, 0.35, 0.75, 1
    elevation: 3
    padding: dp(12)

    AnchorLayout:
        anchor_x: "center"
        anchor_y: "center"
        MDLabel:
            text: root.title
            halign: "center"
            valign: "middle"
            theme_text_color: "Custom"
            text_color: 1, 1, 1, 1
            font_size: sp(app.tipo_font_sp)
            size_hint_y: None
            text_size: self.width - dp(12), None
            height: self.texture_size[1] if self.texture_size[1] <= dp(app.tipo_card_height_dp) - dp(24) else dp(app.tipo_card_height_dp) - dp(24)
            max_lines: 3

    MDFlatButton:
        id: hit
        text: ""
        size_hint: 1, 1
        pos_hint: {"center_x": .5, "center_y": .5}
        md_bg_color: 0, 0, 0, 0

# ---------------------- TECLADO NUMÉRICO (DIALOG LEGADO) ----------------------

<NumericKeypad@MDBoxLayout>:
    orientation: "vertical"
    spacing: dp(10)
    padding: dp(8)

    MDLabel:
        text: app.keypad_value if app.keypad_value else "0"
        halign: "center"
        font_style: "H4"
        theme_text_color: "Primary"
        size_hint_y: None
        height: dp(40)

    GridLayout:
        cols: 3
        spacing: dp(8)
        size_hint_y: None
        height: self.minimum_height

        MDRaisedButton:
            text: "1"
            on_release: app.keypad_add_digit("1")
        MDRaisedButton:
            text: "2"
            on_release: app.keypad_add_digit("2")
        MDRaisedButton:
            text: "3"
            on_release: app.keypad_add_digit("3")
        MDRaisedButton:
            text: "4"
            on_release: app.keypad_add_digit("4")
        MDRaisedButton:
            text: "5"
            on_release: app.keypad_add_digit("5")
        MDRaisedButton:
            text: "6"
            on_release: app.keypad_add_digit("6")
        MDRaisedButton:
            text: "7"
            on_release: app.keypad_add_digit("7")
        MDRaisedButton:
            text: "8"
            on_release: app.keypad_add_digit("8")
        MDRaisedButton:
            text: "9"
            on_release: app.keypad_add_digit("9")
        MDRaisedButton:
            text: "⌫"
            on_release: app.keypad_backspace()
        MDRaisedButton:
            text: "0"
            on_release: app.keypad_add_digit("0")
        MDRaisedButton:
            text: "Limpar"
            on_release: app.keypad_clear()

    MDBoxLayout:
        size_hint_y: None
        height: dp(56)
        spacing: dp(8)
        MDRaisedButton:
            text: "Cancelar"
            on_release: app.keypad_cancel()
        MDRaisedButton:
            text: "OK"
            on_release: app.keypad_confirm()

# ---------------------- TELAS PRINCIPAIS ----------------------

ScreenManager:
    HomeScreen:
    ProducaoScreen:
    InventarioScreen:
    DetalheProdutoScreen:
    ResumoProducaoScreen:

<HomeScreen@MDScreen>:
    name: "home"
    MDFloatLayout:
        MDTopAppBar:
            title: "Gestão da Cozinha"
            pos_hint: {"top": 1}
            elevation: 10

        MDLabel:
            text: "Escolha uma opção"
            halign: "center"
            font_style: "H4"
            pos_hint: {"center_x": .5, "center_y": .7}

        MDRaisedButton:
            text: "Produção"
            pos_hint: {"center_x": .5, "center_y": .5}
            size_hint: .6, None
            height: "60dp"
            font_size: "18sp"
            on_release: app.go("producao")

        MDRaisedButton:
            text: "Inventário"
            pos_hint: {"center_x": .5, "center_y": .38}
            size_hint: .6, None
            height: "60dp"
            font_size: "18sp"
            on_release: app.go("inventario")

<ProducaoScreen@MDScreen>:
    name: "producao"
    MDFloatLayout:
        MDTopAppBar:
            title: "Produção"
            left_action_items: [["arrow-left", lambda x: app.nav_back()]]
            right_action_items: [["refresh", lambda x: app.recarregar_produtos(True)], ["file-document-outline", lambda x: app.abrir_resumo()]]
            pos_hint: {"top": 1}
            elevation: 10

        MDLabel:
            id: status
            text: "Carregando..."
            halign: "center"
            markup: True
            font_style: "H6"
            pos_hint: {"center_x": .5, "center_y": .83}

        MDLabel:
            id: selected_label
            text: ""
            markup: True
            halign: "center"
            font_style: "H6"
            pos_hint: {"center_x": .5, "center_y": .80}
            opacity: 0

        MDBoxLayout:
            id: action_bar
            orientation: "horizontal"
            spacing: dp(12)
            size_hint: .9, None
            height: dp(60)
            pos_hint: {"center_x": .5, "y": .70}
            opacity: 0
            disabled: True

            MDRaisedButton:
                text: "Adicionar produção"
                font_size: "18sp"
                on_release: app.abrir_teclado_numerico()

            MDRaisedButton:
                text: "Voltar aos produtos"
                font_size: "18sp"
                on_release: app.desmarcar_produto()

        ScrollView:
            size_hint: 1, .62
            pos_hint: {"x": 0, "y": .06}
            do_scroll_x: False
            MDGridLayout:
                id: grid
                cols: app.cols_grid
                spacing: dp(12)
                padding: dp(12), dp(6), dp(12), dp(12)
                adaptive_height: True
                size_hint_x: 1

        MDLabel:
            text: " "
            size_hint_y: None
            height: dp(6)
            pos_hint: {"x": 0, "y": 0}

<InventarioScreen@MDScreen>:
    name: "inventario"
    MDFloatLayout:
        MDTopAppBar:
            title: "Inventário"
            left_action_items: [["arrow-left", lambda x: app.nav_back()]]
            pos_hint: {"top": 1}
            elevation: 10

        MDLabel:
            text: "Tela de Inventário (em breve)"
            halign: "center"
            font_style: "H5"
            pos_hint: {"center_x": .5, "center_y": .5}

# ==================== COMPONENTE: NumericPad (mais 10% de largura) ====================
<NumericPad@MDCard>:
    radius: [18,]
    elevation: 1
    padding: dp(12)
    size_hint: None, None
    # ~ 15.125% da largura do pai (≈10% maior que a versão anterior),
    # com novos limites para garantir usabilidade em telas pequenas/grandes.
    width: (min(max(self.parent.width * 0.15125, dp(242)), dp(580)) if self.parent else dp(290))
    height: self.minimum_height
    md_bg_color: 0.92, 0.96, 1, 1   # azul bem claro

    canvas.before:
        Color:
            rgba: 0.80, 0.83, 0.90, 1
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 18)
            width: 1.2

    MDBoxLayout:
        orientation: "vertical"
        spacing: dp(10)
        adaptive_height: True

        # Visor
        MDLabel:
            text: app.keypad_value if app.keypad_value else "0"
            halign: "center"
            font_style: "H4"
            theme_text_color: "Custom"
            text_color: 0.12, 0.15, 0.20, 1
            size_hint_y: None
            height: dp(40)

        # Separador
        Widget:
            size_hint_y: None
            height: dp(1)
            canvas.before:
                Color:
                    rgba: 0.88, 0.90, 0.94, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

        # Teclas 3x4 — mais largas e mais baixas (melhor proporção)
        AnchorLayout:
            anchor_x: "center"
            anchor_y: "center"
            size_hint_y: None
            height: grid_keys.height

            GridLayout:
                id: grid_keys
                cols: 3
                spacing: dp(6)
                size_hint: None, None
                col_default_width: dp(68)
                col_force_default: True
                row_default_height: dp(44)
                row_force_default: True
                width: dp(68) * 3 + dp(6) * 2
                height: self.minimum_height

                MDRaisedButton:
                    text: "1"
                    on_release: app.keypad_add_digit("1")
                MDRaisedButton:
                    text: "2"
                    on_release: app.keypad_add_digit("2")
                MDRaisedButton:
                    text: "3"
                    on_release: app.keypad_add_digit("3")

                MDRaisedButton:
                    text: "4"
                    on_release: app.keypad_add_digit("4")
                MDRaisedButton:
                    text: "5"
                    on_release: app.keypad_add_digit("5")
                MDRaisedButton:
                    text: "6"
                    on_release: app.keypad_add_digit("6")

                MDRaisedButton:
                    text: "7"
                    on_release: app.keypad_add_digit("7")
                MDRaisedButton:
                    text: "8"
                    on_release: app.keypad_add_digit("8")
                MDRaisedButton:
                    text: "9"
                    on_release: app.keypad_add_digit("9")

                MDRaisedButton:
                    text: "⌫"
                    on_release: app.keypad_backspace()
                MDRaisedButton:
                    text: "0"
                    on_release: app.keypad_add_digit("0")
                MDRaisedButton:
                    text: "Limpar"
                    on_release: app.keypad_clear()

        # Ações — somente 2 botões (verde e azul)
        AnchorLayout:
            anchor_x: "center"
            anchor_y: "center"
            size_hint_y: None
            height: row_actions.height

            GridLayout:
                id: row_actions
                cols: 2
                spacing: dp(6)
                size_hint: None, None
                col_default_width: dp(100)
                col_force_default: True
                row_default_height: dp(44)
                row_force_default: True
                width: dp(100) * 2 + dp(6)
                height: self.minimum_height

                MDRaisedButton:
                    text: "Adicionar"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1
                    md_bg_color: 0.0, 0.65, 0.0, 1
                    on_release: app.confirmar_ajuste_quantidade(1)

                MDRaisedButton:
                    text: "Subtrair"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1
                    md_bg_color: 0.10, 0.40, 0.95, 1
                    on_release: app.confirmar_ajuste_quantidade(-1)


# ==================== TELA: Detalhe do Produto ====================
<DetalheProdutoScreen@MDScreen>:
    name: "detalhe_produto"
    on_pre_enter: app._sync_qtd_display()

    MDFloatLayout:

        # AppBar com voltar
        MDTopAppBar:
            left_action_items: [["arrow-left", lambda x: app.nav_back()]]
            pos_hint: {"top": 1}
            elevation: 10

        # Cabeçalho azul – tipografia marcante
        MDCard:
            radius: [18,]
            elevation: 2
            padding: dp(14)
            size_hint: .94, None
            height: dp(116)
            pos_hint: {"center_x": .5, "top": .90}
            md_bg_color: 0.12, 0.35, 0.75, 1
            MDBoxLayout:
                orientation: "vertical"
                spacing: dp(2)
                MDLabel:
                    id: titulo_produto
                    text: app.produto_selecionado or "Produto"
                    halign: "center"
                    font_style: "H3"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1
                MDLabel:
                    id: qtd_atual
                    text: "Quantidade atual: " + str(app.qtd_atual_display)
                    halign: "center"
                    font_style: "H6"
                    theme_text_color: "Custom"
                    text_color: 0.92, 0.95, 0.99, 1

        # Teclado compacto mais para baixo (não cobre o cabeçalho)
        AnchorLayout:
            anchor_x: "center"
            anchor_y: "center"
            size_hint: 1, None
            height: keypad.height
            pos_hint: {"center_x": .5, "y": .06}   # próximo ao rodapé
            NumericPad:
                id: keypad
